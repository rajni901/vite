"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.run = void 0;
const villageClient_1 = require("@common/villageClient");
const auth_1 = require("@common/auth");
const run = (program) => {
    program
        .command('run')
        .description('Run the latest build for a script')
        .argument('<script_id>', 'The ID of the script to run')
        .option('-p, --params [key=value...]', 'Pass options to the script')
        .action(async function () {
        const debug = this.opts().debug;
        const authed = await (0, auth_1.setAuthHeader)({ debug });
        if (!authed) {
            return;
        }
        const rawParams = this.opts().params;
        let params;
        try {
            const splitParams = rawParams.map((x) => x.split('=', 2));
            params = Object.fromEntries(splitParams);
        }
        catch (err) {
            console.log('Invalid params format.');
            return;
        }
        villageClient_1.villageClient.scripts
            .runScript({ script_id: program.args[1], params })
            .then(({ build_id: buildId, output }) => {
            console.log(`Running script ${program.args[1]} with build ${buildId}`);
            console.log(output);
        })
            .catch(auth_1.warnUnauthenticated)
            .catch((err) => {
            console.error(err);
        });
    });
};
exports.run = run;
//# sourceMappingURL=run.js.map